<div class="container p-3">
    <div id="submissionView" style="display: none;">
        <div class="w-100 text-center my-3">
            <img src="/logo.png" alt="Insightic Logo" style="width: 60px; height: 60px;">
            <h2>Contract Diff</h2>
            <div class="w-100 mx-auto" style="max-width: 720px;">Contract Diff is a tool utilized for cross-validation
                and
                examination of whitepapers and smart contracts.
                By scrutinizing the whitepaper and smart contract, Contract Diff possesses the ability to uncover
                disparities between them and provide appropriate warnings.</div>
        </div>

        <div class="w-100 text-center mx-auto my-3 border rounded p-3" style="max-width: 640px;">
            <h3>Step 1</h3>
            <div class="w-100 my-2 mx-auto">Upload whitepaper</div>
            <div class="w-100 my-2 mx-auto" style="max-width: 320px;">
                <input class="form-control" type="file" id="whitepaperFile">
            </div>
        </div>

        <div class="w-100 text-center mx-auto my-3 border rounded p-3" style="max-width: 640px;">
            <h3>Step 2</h3>
            <div class="w-100 my-2 mx-auto">Upload Smart Contract code</div>
            <div class="w-100 my-2 mx-auto" style="max-width: 320px;">
                <input class="form-control" type="file" id="codeFile">
            </div>
        </div>

        <div class="w-100 text-center my-3">
            <button class="btn btn-lg btn-danger text-center" id="submit" style="width: 200px;">
                <div id="submit-show-risks" class="mx-auto" style="display: block;">Show Me Risks!</div>
                <div id="submit-show-loading" class="mx-auto spinner-border" style="display: none;">
                </div>
            </button>
        </div>
    </div>

    <div id="resultsView" style="display: block;">
        <div class="w-100 text-center my-3">
            <img src="/logo.png" alt="Insightic Logo" style="width: 60px; height: 60px;">
            <h2>Contract Diff - Results</h2>
            <div>Job ID: <span id="jobId"></span></div>
        </div>

        <div class="w-100 my-3 mx-auto" style="max-width: 720px;">
            <table class="table">
                <thead class="table-dark">
                    <th width="30%">Description</th>
                    <th width="30%">Whitepaper</th>
                    <th width="30%">Code</th>
                </thead>
                <tbody id="results">
                </tbody>
            </table>
        </div>

        <div class="w-100 text-center my-3">
            <a class="btn btn-lg btn-primary text-center" style="width: 200px;" type="button" href="/contract-diff">
                Try again
            </a>
        </div>
    </div>
</div>

<script>
    (async function () {
        const uri = new URL(window.location.href);
        const jobId = uri.searchParams.get('jobId');
        if (!jobId) {
            // No job ID, show submission view
            $('#submissionView').style.display = 'block';
            $('#resultsView').style.display = 'none';

            const whitepaperFileEle = $('#whitepaperFile');
            const codeFileEle = $('#codeFile');
            const submitEle = $('#submit');

            submitEle.addEventListener('click', async function () {
                const whitepaperFile = whitepaperFileEle.files[0];
                const codeFile = codeFileEle.files[0];

                if (!whitepaperFile || !codeFile) {
                    alert('You have choose both Whitepaper and Code!');
                    return;
                }

                $('#submit-show-risks').style.display = 'none';
                $('#submit-show-loading').style.display = 'block';
                submitEle.disabled = true;

                const whitepaperObjectId = await window.uploadFile(whitepaperFile);
                const codeObjectId = await window.uploadFile(codeFile);

                const resp = await axios.post("http://13.250.10.129/jobs", {
                    whitepaper_id: whitepaperObjectId,
                    code_id: codeObjectId
                });

                const jobId = resp.data.guid;
                window.location.href = `/contract-diff?jobId=${jobId}`;

                $('#submit-show-risks').style.display = 'block';
                $('#submit-show-loading').style.display = 'none';
                submitEle.disabled = false;
            });
        } else {
            // Job ID exists, show results view
            $('#submissionView').style.display = 'none';
            $('#resultsView').style.display = 'block';
            $('#jobId').innerText = jobId;

            const resp = await axios.get(`http://13.250.10.129/jobs/${jobId}`);
            const results = resp.data.results.sort((a, b) => a.id - b.id);

            $('#results').innerHTML = results.map((result) => {
                return `
                    <tr>
                        <td>${result.description}</td>
                        <td>${result.whitepaper}</td>
                        <td>${result.code}</td>
                    </tr>
                `;
            }).join('');
        }
    })().then();
</script>